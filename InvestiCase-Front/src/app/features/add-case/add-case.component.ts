import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { HttpClientModule } from '@angular/common/http';
import { Router } from '@angular/router';
import { ApiService } from '../../core/services/api.service';

@Component({
  selector: 'app-add-case',
  standalone: true,
  imports: [CommonModule, HttpClientModule, FormsModule],
  templateUrl: './add-case.component.html',
  styleUrls: ['./add-case.component.css']
})
export class AddCaseComponent {
  step = 1;
  mainTypes = ['مدني', 'جزائي', 'إداري', 'محاضر وشكايات'];

  subTypesByMainType: { [key: string]: string[] } = {
    'مدني': [
      'أوامر بالدفع',
      'طلاق',
      'الأذون على العرائض',
      'التسوية القضائية',
      'الأكرية التجارية',
      'بيع العقارات المقولبة',
      'شغلي',
      'استعجالي',
      'قضايا التقديم',
      'الضمان الاجتماعي',
      'الاعتراض والتمس اعادة النظر',
      'استئناف قضايا حوادث الشغل والأمراض المهنية',
      'استئناف قرارات دوائر الشغل',
      'استئناف الأحكام المدنية الصادرة عن النواحي',
      'الحالة المدنية',
      'توزيع الأموال',
      'مدني',
      'عقلة الأجور والمرتبات',
      'حوادث الشغل',
      'التبني'
    ],
    'جزائي': [
      'جناحي أصلي',
      'جنائي إعتراضي',
      'جناحي إعتراضي',
      'جنائي أصلي',
      'تحقيق',
      'دائرة إتهام'
    ],
    'إداري': [
      'استعجالي',
      'أصلية'
    ],
    'محاضر وشكايات': [
      'محاضر وشكايات'
    ]
  };

  phases = [
    'تحقيق', 'محاكمة', 'استئناف', 'تعقيب', 'جلسة أولى', 'جلسة ثانية', 'جلسة نهائية'
  ];
  
  courts = [
    // محاكم الاستئناف
    'محكمة الاستئناف بتونس',
    'محكمة الاستئناف ببنزرت',
    'محكمة الاستئناف بنابل',
    'محكمة الاستئناف بصفاقس',
    'محكمة الاستئناف بسوسة',
    'محكمة الاستئناف بالكاف',
    'محكمة الاستئناف بالمنستير',
    'محكمة الاستئناف بقفصة',
    'محكمة الاستئناف بمدنين',
    'محكمة الاستئناف بقابس',
    'محكمة الاستئناف بالقصرين',
    'محكمة الاستئناف بسيدى بوزيد',
    'محكمة الاستئناف بالقيروان',
    'محكمة الاستئناف بجندوبة',
    'محكمة الاستئناف بباجة',
    'محكمة الاستئناف بسليانة',

    // المحاكم الابتدائية
    'المحكمة الابتدائية بتونس',
    'محكمة الأحداث بتونس',
    'المحكمة الابتدائية باريانة',
    'محكمة الأحداث بأريانة',
    'المحكمة الابتدائية ببنعروس',
    'محكمة الأحداث ببنعروس',
    'المحكمة الابتدائية منوبة',
    'محكمة الأحداث بمنوبة',
    'المحكمة الابتدائية بتونس 2',
    'المحكمة الابتدائية ببنزرت',
    'المحكمة الابتدائية بباجة',
    'المحكمة الابتدائية بزغوان',
    'المحكمة الابتدائية بقرمبالية',
    'المحكمة الابتدائية بصفاقس 2',
    'المحكمة الابتدائية بنابل',
    'المحكمة الابتدائية بصفاقس',
    'المحكمة الابتدائية بسوسة',
    'محكمة الأحداث بسوسة',
    'المحكمة الابتدائية بالقيروان',
    'المحكمة الابتدائية بالكاف',
    'المحكمة الابتدائية بسليانة',
    'المحكمة الابتدائية بالقصرين',
    'المحكمة الابتدائية بجندوبة',
    'المحكمة الابتدائية بالمنستير',
    'المحكمة الابتدائية بالمهدية',
    'المحكمة الابتدائية بقفصة',
    'المحكمة الابتدائية بسيدي بوزيد',
    'المحكمة الابتدائية بتوزر',
    'المحكمة الابتدائية بمدنين',
    'المحكمة الابتدائية بتطاوين',
    'المحكمة الابتدائية بقابس',
    'المحكمة الابتدائية بقبلي',
    'المحكمة الابتدائية بسوسة 2',

    // محاكم النواحي
    'محكمة ناحية تونس',
    'محكمة ناحية باردو',
    'محكمة ناحية قرطاج',
    'محكمة ناحية حي الزهور',
    'محكمة ناحية الوردية',
    'محكمة ناحية بنزرت',
    'محكمة ناحية منزل بورقيبة',
    'محكمة ناحية ماطر',
    'محكمة ناحية راس الجبل',
    'محكمة ناحية باجة',
    'محكمة ناحية مجاز الباب',
    'محكمة ناحية تبرسق',
    'محكمة ناحية زغوان',
    'محكمة ناحية الفحص',
    'محكمة ناحية نابل',
    'محكمة ناحية قرمبالية',
    'محكمة ناحية منزل تميم',
    'محكمة ناحية الحمامات',
    'محكمة ناحية بن عروس',
    'محكمة ناحية حمام الانف',
    'محكمة ناحية أريانة',
    'محكمة ناحية صفاقس',
    'محكمة ناحية جبنيانة',
    'محكمة ناحية المحرس',
    'محكمة ناحية عقارب',
    'محكمة ناحية سوسة',
    'محكمة ناحية مساكن',
    'محكمة ناحية النفيضة',
    'محكمة ناحية القيروان',
    'محكمة ناحية حفوز',
    'محكمة ناحية بوحجلة',
    'محكمة ناحية الوسلاتية',
    'محكمة ناحية السبيخة',
    'محكمة ناحية الكاف',
    'محكمة ناحية تاجروين',
    'محكمة ناحية الدهماني',
    'محكمة ناحية سليانة',
    'محكمة ناحية مكثر',
    'محكمة ناحية قعفور',
    'محكمة ناحية القصرين',
    'محكمة ناحية تالة',
    'محكمة ناحية سبيطلة',
    'محكمة ناحية سبيبة',
    'محكمة ناحية فريانة',
    'محكمة ناحية جندوبة',
    'محكمة ناحية بوسالم',
    'محكمة ناحية عين دراهم',
    'محكمة ناحية غار الدماء',
    'محكمة ناحية جمال',
    'محكمة ناحية مكنين',
    'محكمة ناحية المهدية',
    'محكمة ناحية السواسي',
    'محكمة ناحية الجم',
    'محكمة ناحية قصور الساف',
    'محكمة ناحية الشابة',
    'محكمة ناحية قفصة',
    'محكمة ناحية المتلوي',
    'محكمة ناحية سيدي بوزيد',
    'محكمة ناحية بنعون',
    'محكمة ناحية المكناسي',
    'محكمة ناحية توزر',
    'محكمة ناحية مدنين',
    'محكمة ناحية بنقردان',
    'محكمة ناحية جرجيس',
    'محكمة ناحية جربة',
    'محكمة ناحية تطاوين',
    'محكمة ناحية قابس',
    'محكمة ناحية الحامة',
    'محكمة ناحية مارث',
    'محكمة ناحية مطماطة',
    'محكمة ناحية قبلي',
    'محكمة ناحية المنستير',
    'محكمة ناحية صفاقس 2',
    'محكمة ناحية ساقية الزيت',
    'محكمة ناحية غمراسن',
    'محكمة ناحية فوسانة',
    'محكمة ناحية طبرقة',
    'محكمة ناحية جلمة',
    'محكمة ناحية الرقاب',
    'محكمة ناحية منزل بوزلفة',
    'محكمة ناحية طبربة',
    'محكمة الناحية حي التضامن',
    'محكمة ناحية منوبة',
    'محكمة ناحية سوسة 2',
    'محكمة ناحية بئر علي بن خليفة',
    'محكمة ناحية نفزة'
  ];

  availableSubTypes: string[] = [];
  selectedMainType = '';

  caseData: any = {
    mainType: '',
    caseNumber: '',
    caseType: '',
    phase: '',
    judicialYear: '',
    court: '',
    plaintiff: '',
    plaintiffPhone: '',
    opponent: '',
    lawyer: '',
    client: '',
    nextSession: '',
    subject: '',
    comments: '',
    document: null
  };
  loading = false;
  error = '';

  constructor(
    private apiService: ApiService,
    private router: Router
  ) {}

  selectMainType(type: string) {
    this.selectedMainType = type;
    this.availableSubTypes = this.subTypesByMainType[type] || [];
    this.caseData.mainType = type;
    this.caseData.caseType = '';
  }

  nextStep() {
    if (this.step === 1 && this.selectedMainType && this.caseData.caseType) {
      this.step = 2;
    }
  }

  prevStep() {
    this.step = 1;
  }

  onFileChange(event: any) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        this.caseData.document = reader.result;
      };
      reader.readAsArrayBuffer(file);
    }
  }

  isComplaintType(): boolean {
    return this.selectedMainType === 'محاضر وشكايات';
  }

  submitCase() {
    this.loading = true;
    if (this.isComplaintType()) {
      // Set other fields to null for محاضر وشكايات type
      this.caseData.phase = null;
      this.caseData.plaintiffPhone = null;
      this.caseData.opponent = null;
      this.caseData.client = null;
      this.caseData.nextSession = null;
      this.caseData.subject = null;
    }

    this.apiService.createCase(this.caseData).subscribe({
      next: () => {
        this.loading = false;
        this.router.navigate(['/archive']);
      },
      error: () => {
        this.loading = false;
        this.error = 'Erreur lors de l\'ajout.';
      }
    });
  }
}
